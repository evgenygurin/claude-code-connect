name: Sentry Integration

# This workflow integrates Sentry error monitoring with Codegen AI agent
# Automatically creates issues and fixes from production errors
# Requires Sentry connected at: https://codegen.com/settings/integrations/sentry

on:
  # Webhook events from Sentry (via Codegen relay)
  repository_dispatch:
    types:
      - sentry-error
      - sentry-issue-created
      - sentry-performance-alert

  # Issue events for Sentry-tagged issues
  issues:
    types: [opened, labeled]

  # Manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      sentry_issue_id:
        description: 'Sentry Issue ID (e.g., PROJ-123)'
        required: true
        type: string
      error_message:
        description: 'Error message/description'
        required: false
        type: string

# Permissions required for Sentry integration
permissions:
  contents: write           # Read/write repository contents
  pull-requests: write      # Create and manage PRs
  issues: write            # Create and comment on issues
  checks: write            # Update check runs
  statuses: write          # Update commit statuses

jobs:
  # Job 1: Handle Sentry Error Events
  sentry-error-handler:
    name: Handle Sentry Error
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'repository_dispatch' &&
      (github.event.action == 'sentry-error' ||
       github.event.action == 'sentry-issue-created' ||
       github.event.action == 'sentry-performance-alert')

    steps:
      - name: Extract Sentry Error Details
        id: sentry
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload.client_payload;

            core.setOutput('issue_id', payload.issue_id || 'unknown');
            core.setOutput('error_title', payload.title || 'Sentry Error');
            core.setOutput('error_message', payload.message || '');
            core.setOutput('stack_trace', payload.stack_trace || '');
            core.setOutput('severity', payload.level || 'error');
            core.setOutput('environment', payload.environment || 'production');
            core.setOutput('url', payload.url || 'https://sentry.io');

      - name: Create GitHub Issue from Sentry Error
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueId = '${{ steps.sentry.outputs.issue_id }}';
            const title = '${{ steps.sentry.outputs.error_title }}';
            const message = '${{ steps.sentry.outputs.error_message }}';
            const stackTrace = '${{ steps.sentry.outputs.stack_trace }}';
            const severity = '${{ steps.sentry.outputs.severity }}';
            const environment = '${{ steps.sentry.outputs.environment }}';
            const sentryUrl = '${{ steps.sentry.outputs.url }}';

            const issueBody = [
              '## üö® Sentry Error Report',
              '',
              `**Issue ID**: ${issueId}`,
              `**Severity**: ${severity}`,
              `**Environment**: ${environment}`,
              `**Sentry URL**: [View in Sentry](${sentryUrl})`,
              '',
              '### Error Message',
              '',
              '```',
              message,
              '```',
              '',
              '### Stack Trace',
              '',
              '```',
              stackTrace,
              '```',
              '',
              '---',
              '',
              '**Auto-generated by Sentry ‚Üí Codegen Integration**',
              '',
              '**Next Steps:**',
              '1. ‚úÖ Codegen will analyze this error automatically',
              '2. ü§ñ @codegen will create a PR with a fix',
              '3. üë• Review and merge the fix',
              '4. ‚úÖ Sentry issue will be marked as resolved',
              '',
              '**Trigger Codegen manually:**',
              '```',
              '@codegen fix this sentry error',
              '```'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Sentry] ${title}`,
              body: issueBody,
              labels: ['sentry', 'production-bug', 'high-priority', 'codegen']
            });

            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

            return issue.data.number;

      - name: Trigger Codegen Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = '${{ steps.create_issue.outputs.issue_number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: parseInt(issueNumber),
              body: [
                'ü§ñ **Codegen Agent Activated**',
                '',
                'Analyzing Sentry error and preparing fix...',
                '',
                '**Analysis Steps:**',
                '1. üîç Parse stack trace and error context',
                '2. üìÇ Identify affected files and functions',
                '3. üß™ Analyze similar past errors',
                '4. üí° Generate fix strategy',
                '5. ‚úÖ Implement fix with tests',
                '6. üìù Create PR with detailed explanation',
                '',
                'üìä Track progress at: https://codegen.com/runs',
                '',
                '> **Note**: This is a production error. The fix will be thoroughly tested before PR creation.'
              ].join('\n')
            });

  # Job 2: Handle Sentry-labeled Issues
  sentry-issue-handler:
    name: Handle Sentry Issue
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issues' &&
      (github.event.action == 'opened' || github.event.action == 'labeled') &&
      contains(github.event.issue.labels.*.name, 'sentry')

    steps:
      - name: Notify Codegen Agent
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: [
                'üîß **Sentry Issue Auto-fixer**',
                '',
                `**Issue**: ${issueTitle}`,
                '',
                'The Codegen agent will analyze this Sentry error and attempt to create a fix.',
                '',
                '**Automated Actions:**',
                '- ‚úÖ Analyze error context and stack trace',
                '- ‚úÖ Identify root cause',
                '- ‚úÖ Generate fix with tests',
                '- ‚úÖ Create PR linked to this issue',
                '- ‚úÖ Update Sentry when PR is merged',
                '',
                'üìä Track at: https://codegen.com/runs',
                '',
                '**Priority**: High (Production Bug)',
                '**Auto-fix**: Enabled with review required',
                '',
                '> Mention @codegen for specific instructions or questions.'
              ].join('\n')
            });

  # Job 3: Manual Sentry Issue Handling
  sentry-manual:
    name: Manual Sentry Fix
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Create Issue for Manual Sentry Error
        uses: actions/github-script@v7
        with:
          script: |
            const sentryIssueId = "${{ github.event.inputs.sentry_issue_id }}";
            const errorMessage = "${{ github.event.inputs.error_message }}" || "Manual Sentry error report";

            const issueBody = [
              '## üö® Manual Sentry Error Report',
              '',
              `**Sentry Issue ID**: ${sentryIssueId}`,
              `**Reported by**: @${{ github.actor }}`,
              '',
              '### Description',
              '',
              errorMessage,
              '',
              '---',
              '',
              '**Manual trigger**: This issue was created manually via workflow dispatch.',
              '',
              '**Next Steps:**',
              '1. ‚úÖ Add error details, stack trace, and context',
              '2. ü§ñ Mention @codegen to trigger automatic fix',
              '3. üë• Review the generated PR',
              '4. ‚úÖ Merge and deploy the fix',
              '',
              '**Trigger Codegen:**',
              '```',
              '@codegen analyze and fix this Sentry error',
              '```'
            ].join('\n');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Sentry] ${sentryIssueId}: ${errorMessage.substring(0, 60)}`,
              body: issueBody,
              labels: ['sentry', 'production-bug', 'manual', 'codegen']
            });

            core.info(`Created issue #${issue.data.number}`);
            core.info(`URL: ${issue.data.html_url}`);

  # Job 4: Sentry Integration Status Check
  sentry-status:
    name: Check Sentry Integration
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify Sentry Configuration
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const yaml = require('js-yaml');

            try {
              const configFile = fs.readFileSync('.codegen/config.yml', 'utf8');
              const config = yaml.load(configFile);

              const sentryEnabled = config?.integrations?.sentry?.enabled || false;
              const autoFix = config?.integrations?.sentry?.auto_fix || false;

              core.info(`Sentry Integration Status:`);
              core.info(`  Enabled: ${sentryEnabled ? '‚úÖ' : '‚ùå'}`);
              core.info(`  Auto-fix: ${autoFix ? '‚úÖ' : '‚ùå'}`);

              if (sentryEnabled) {
                core.info(`\n‚úÖ Sentry integration is configured and enabled`);
                core.info(`\nNext steps:`);
                core.info(`1. Connect Sentry at: https://codegen.com/settings/integrations/sentry`);
                core.info(`2. Configure webhooks in your Sentry project`);
                core.info(`3. Test by creating a test error in Sentry`);
              } else {
                core.warning(`\n‚ö†Ô∏è Sentry integration is not enabled in .codegen/config.yml`);
                core.info(`\nEnable it by setting:`);
                core.info(`integrations:`);
                core.info(`  sentry:`);
                core.info(`    enabled: true`);
              }
            } catch (error) {
              core.error(`Failed to check Sentry configuration: ${error.message}`);
            }

# ================================================================================
# Sentry Integration Workflow
# ================================================================================
#
# This workflow handles Sentry error monitoring and automatic fixing via Codegen.
#
# SETUP STEPS:
# 1. Enable Sentry in .codegen/config.yml (already done ‚úÖ)
# 2. Connect Sentry at: https://codegen.com/settings/integrations/sentry
# 3. Configure Sentry webhooks:
#    - URL: https://api.codegen.com/webhooks/sentry
#    - Events: error.created, issue.created, performance.alert
#
# FEATURES:
# - ‚úÖ Auto-create GitHub issues from Sentry errors
# - ‚úÖ Trigger Codegen agent to fix production errors
# - ‚úÖ Link PRs to Sentry issues
# - ‚úÖ Update Sentry when issues are resolved
# - ‚úÖ Priority-based handling (high/critical errors only)
#
# USAGE:
# - Automatic: Sentry errors ‚Üí GitHub issues ‚Üí Codegen fixes
# - Manual: Run workflow_dispatch with Sentry issue ID
# - Comment: Add 'sentry' label to any issue to trigger Codegen
#
# DOCUMENTATION:
# - Sentry Integration: docs/CODEGEN-INTEGRATIONS.md
# - Codegen Setup: docs/CODEGEN-GITHUB-APP-SETUP.md
# - Sentry Docs: https://docs.sentry.io/product/integrations/
#
# ================================================================================
