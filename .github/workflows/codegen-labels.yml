name: Codegen Label Triggers

# Handles label-based triggers for Codegen GitHub App
# The actual agent processing is done by Codegen GitHub App via webhooks
on:
  pull_request:
    types: [labeled]
  issues:
    types: [labeled]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # Job 1: Handle Codegen Labels
  codegen-label-handler:
    name: Handle Codegen Labels
    runs-on: ubuntu-latest
    if: |
      startsWith(github.event.label.name, 'codegen')

    steps:
      - name: Acknowledge label trigger
        uses: actions/github-script@v7
        with:
          script: |
            const label = context.payload.label.name;
            const number = context.payload.pull_request?.number || context.payload.issue?.number;
            const title = context.payload.pull_request?.title || context.payload.issue?.title;
            const isPR = !!context.payload.pull_request;

            // Determine task description based on label
            let taskDescription = '';
            let emoji = 'ü§ñ';

            switch (label) {
              case 'codegen:bug-fix':
                taskDescription = 'Analyze and fix the bug described in this issue/PR';
                emoji = 'üêõ';
                break;
              case 'codegen:feature':
                taskDescription = 'Implement the feature request';
                emoji = '‚ú®';
                break;
              case 'codegen:refactor':
                taskDescription = 'Refactor code for better quality and maintainability';
                emoji = '‚ôªÔ∏è';
                break;
              case 'codegen:auto-fix':
                taskDescription = 'Automatically fix failing tests, linting, and CI issues';
                emoji = 'üîß';
                break;
              case 'codegen:review':
                taskDescription = 'Perform comprehensive code review';
                emoji = 'üëÄ';
                break;
              case 'codegen:tests':
                taskDescription = 'Add comprehensive test coverage';
                emoji = 'üß™';
                break;
              case 'codegen:docs':
                taskDescription = 'Update documentation';
                emoji = 'üìö';
                break;
              case 'codegen':
                taskDescription = 'Process the request based on title and description';
                emoji = 'ü§ñ';
                break;
              default:
                taskDescription = 'Process custom Codegen request';
                emoji = 'ü§ñ';
            }

            const itemType = isPR ? 'PR' : 'Issue';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              body: `${emoji} **Codegen Label Handler**\n\n**Label:** \`${label}\`\n**${itemType}:** ${title}\n**Task:** ${taskDescription}\n\nü§ñ The Codegen GitHub App will process this request automatically.\n\nüìä Track at: https://codegen.com/runs\n\n> **Note**: Make sure the Codegen GitHub App is installed.\n> Install at: https://github.com/apps/codegen-sh`
            });

  # Job 2: Auto-label based on keywords
  auto-label-codegen:
    name: Auto-label for Codegen
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || github.event_name == 'issues') &&
      github.event.action == 'opened'

    steps:
      - name: Check for Codegen keywords
        id: check-keywords
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.pull_request?.title || context.payload.issue?.title || '';
            const body = context.payload.pull_request?.body || context.payload.issue?.body || '';
            const number = context.payload.pull_request?.number || context.payload.issue?.number;

            // Get existing labels
            const { data: existingLabels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number
            });

            const labelNames = existingLabels.map(l => l.name);

            // Don't add if already has codegen label
            if (labelNames.some(name => name.startsWith('codegen'))) {
              core.info('Already has a codegen label, skipping');
              return;
            }

            const text = `${title} ${body}`.toLowerCase();

            // Keywords that should trigger Codegen
            const keywords = [
              '@codegen',
              'codegen:',
              'bot:',
              'agent:',
              'auto-fix',
              'autofix'
            ];

            if (keywords.some(keyword => text.includes(keyword))) {
              core.info('Found Codegen keywords, adding label');

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                labels: ['codegen']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: number,
                body: 'üè∑Ô∏è Automatically labeled with `codegen` - the Codegen GitHub App will process this shortly!\n\nüìä Track at: https://codegen.com/runs'
              });
            } else {
              core.info('No Codegen keywords found, skipping');
            }

# ================================================================================
# Codegen Label-based Triggers
# ================================================================================
#
# This workflow handles label-based triggers for Codegen.
# NO SDK OR API TOKENS REQUIRED - everything is handled by the GitHub App.
#
# HOW IT WORKS:
# 1. Add a label (e.g., `codegen:bug-fix`) to a PR or Issue
# 2. This workflow acknowledges the label
# 3. Codegen GitHub App receives webhook and processes the task
# 4. Results are posted back to the PR/Issue
#
# AVAILABLE LABELS:
# - codegen              - Generic task
# - codegen:bug-fix      - Fix bugs
# - codegen:feature      - Implement features
# - codegen:refactor     - Refactor code
# - codegen:auto-fix     - Auto-fix CI failures
# - codegen:review       - Code review
# - codegen:tests        - Add tests
# - codegen:docs         - Update docs
#
# SETUP:
# 1. Install Codegen GitHub App: https://github.com/apps/codegen-sh
# 2. Create labels in your repository (optional - can use existing)
# 3. Configure triggers in: .codegen/config.yml
#
# ================================================================================
