name: Codegen Integration

# This workflow provides acknowledgements and manual triggers
# The actual Codegen processing is handled by the Codegen GitHub App
# Install at: https://github.com/apps/codegen-sh
on:
  # PR events for auto-review
  pull_request:
    types: [opened, synchronize, reopened]

  # PR reviews
  pull_request_review:
    types: [submitted]

  # Issue and PR comments - @codegen mentions
  issue_comment:
    types: [created]

  # Check suite events for auto-fixer
  check_suite:
    types: [completed]

  # Manual workflow dispatch
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Task prompt for Codegen agent'
        required: true
        type: string
      pr_number:
        description: 'PR number (optional)'
        required: false
        type: string

# Permissions required for Codegen integration
permissions:
  contents: write           # Read/write repository contents
  pull-requests: write      # Create and manage PRs
  issues: write            # Comment on issues
  checks: write            # Update check runs
  statuses: write          # Update commit statuses

jobs:
  # Job 1: PR Auto-review Handler
  pr-review:
    name: PR Auto-review
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      (github.event.action == 'opened' || github.event.action == 'synchronize' || github.event.action == 'reopened')

    steps:
      - name: Notify PR review
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `ðŸ¤– **Codegen PR Review**\n\nðŸ“ PR: ${prTitle}\n\nðŸ” The Codegen GitHub App will review this PR automatically.\n\nðŸ“Š Track at: https://codegen.com/runs\n\n> **Tip**: Add \`codegen:review\` label for immediate review or mention @codegen for specific requests.`
            });

  # Job 2: Check Suite Auto-fixer
  check-suite-fixer:
    name: Check Suite Auto-fixer
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'check_suite' &&
      github.event.check_suite.conclusion == 'failure'

    steps:
      - name: Notify auto-fixer
        uses: actions/github-script@v7
        with:
          script: |
            const checkSuite = context.payload.check_suite;
            const headBranch = checkSuite.head_branch;
            const prNumbers = checkSuite.pull_requests.map(pr => pr.number);

            if (prNumbers.length > 0) {
              for (const prNumber of prNumbers) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `ðŸ”§ **Codegen Auto-fixer Activated**\n\nâŒ Check suite failed on branch: \`${headBranch}\`\n\nðŸ¤– Codegen will attempt to fix the failing checks (up to 3 attempts).\n\nðŸ“Š Track at: https://codegen.com/runs\n\n> **Note**: Codegen GitHub App will analyze logs and push fixes automatically.`
                });
              }
            }

  # Job 3: @codegen Mention Handler
  codegen-mention:
    name: Handle @codegen mentions
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@codegen')

    steps:
      - name: Acknowledge mention
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            const commentBody = context.payload.comment.body;

            // Extract task from comment
            const task = commentBody.replace(/@codegen/gi, '').trim();

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `ðŸ‘‹ **Codegen Agent Activated**\n\nâœ… Task received: ${task}\n\nðŸ¤– The Codegen GitHub App will process this request.\n\nðŸ“Š Track agent runs at: https://codegen.com/runs\n\n> **Note**: Make sure the Codegen GitHub App is installed for this repository.\n> Install at: https://github.com/apps/codegen-sh`
            });

  # Job 4: Manual workflow dispatch
  codegen-manual:
    name: Manual Codegen Task
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Notify manual task
        uses: actions/github-script@v7
        with:
          script: |
            const prompt = "${{ github.event.inputs.prompt }}";
            const prNumber = "${{ github.event.inputs.pr_number }}";

            let message = `ðŸ¤– **Manual Codegen Task Initiated**\n\n**Task**: ${prompt}\n\n`;

            if (prNumber) {
              message += `**Target PR**: #${prNumber}\n\n`;
            }

            message += `ðŸ“Š Track at: https://codegen.com/runs\n\n`;
            message += `> **Note**: This task is processed by the Codegen GitHub App.\n`;
            message += `> Install at: https://github.com/apps/codegen-sh`;

            if (prNumber) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: parseInt(prNumber),
                body: message
              });
            } else {
              core.info(message);
            }

# ================================================================================
# Codegen GitHub App Integration
# ================================================================================
#
# This workflow provides acknowledgements for Codegen events.
# The actual AI agent processing is handled by the Codegen GitHub App.
#
# INSTALLATION:
# 1. Install GitHub App: https://github.com/apps/codegen-sh
# 2. Grant permissions to this repository
# 3. Configure at: https://codegen.com/settings
#
# FEATURES (handled automatically by GitHub App):
# - âœ… PR Reviews: Auto-review on PR creation/updates
# - âœ… Check Suite Auto-fixer: Fix failing CI/CD (up to 3 attempts)
# - âœ… @codegen Mentions: Respond to mentions in comments
# - âœ… Label Triggers: Activate on labels like `codegen:bug-fix`
# - âœ… CircleCI Integration: Monitor and fix failing builds
# - âœ… Sentry Integration: Create issues and fixes from production errors
# - âœ… Linear Integration: Sync issues and auto-create PRs
#
# CONFIGURATION:
# - Agent config: .codegen/config.yml
# - Integration setup: https://codegen.com/settings/integrations
# - Documentation: docs/CODEGEN-GITHUB-APP-SETUP.md
#
# NO SDK OR API TOKENS REQUIRED!
# The GitHub App uses OAuth and webhooks - no secrets needed in this workflow.
# ================================================================================
