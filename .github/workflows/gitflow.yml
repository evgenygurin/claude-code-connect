name: Git Flow CI/CD

on:
  push:
    branches: [ dev, stage, prod ]
  pull_request:
    branches: [ dev, stage, prod ]

jobs:
  # Development environment (dev branch)
  dev-ci:
    name: Development CI
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.base_ref == 'dev'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run tests
      run: npm test
      
    - name: Type check
      run: npm run typecheck
      
    - name: Lint code
      run: npm run lint
      
    - name: Build
      run: npm run build

  # Staging environment (stage branch)
  stage-ci:
    name: Staging CI + Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/stage' || github.base_ref == 'stage'
    environment: staging
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run full test suite
      run: npm test -- --coverage
      
    - name: Build for staging
      run: npm run build
      
    - name: Deploy to staging
      run: |
        echo "üöÄ Deploying to STAGING environment..."
        echo "Stage deployment commands –∑–¥–µ—Å—å"

  # Production environment (prod branch) - –¢–†–ï–ë–£–ï–¢ –†–£–ß–ù–û–ì–û –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø
  prod-ci:
    name: Production CI + Deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod' || github.base_ref == 'prod'
    environment: 
      name: production
      url: https://claude-code-connect.production.com
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run production tests
      run: npm test -- --coverage --reporter=verbose
      
    - name: Security audit
      run: npm audit --audit-level moderate
      
    - name: Build for production
      run: npm run build
      
    - name: üõë MANUAL APPROVAL REQUIRED
      run: |
        echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT"
        echo "üë• Requires manual approval in GitHub UI"
        echo "üîí 2 reviewers must approve this deployment"
        
    - name: Deploy to production
      run: |
        echo "üöÄ Deploying to PRODUCTION environment..."
        echo "Production deployment commands –∑–¥–µ—Å—å"

  # Validate PR rules
  pr-validation:
    name: PR Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Validate branch flow
      run: |
        BASE="${{ github.base_ref }}"
        HEAD="${{ github.head_ref }}"
        
        echo "PR: $HEAD ‚Üí $BASE"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å git flow
        case "$BASE" in
          "dev")
            echo "‚úÖ PR –≤ dev –≤–µ—Ç–∫—É —Ä–∞–∑—Ä–µ—à—ë–Ω"
            ;;
          "stage")
            if [[ "$HEAD" == "dev" ]]; then
              echo "‚úÖ dev ‚Üí stage —Ä–∞–∑—Ä–µ—à—ë–Ω"
            else
              echo "‚ùå –í stage –º–æ–∂–Ω–æ –º–µ—Ä–∂–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ dev!"
              exit 1
            fi
            ;;
          "prod")
            if [[ "$HEAD" == "stage" ]]; then
              echo "‚úÖ stage ‚Üí prod —Ä–∞–∑—Ä–µ—à—ë–Ω"
            else
              echo "‚ùå –í prod –º–æ–∂–Ω–æ –º–µ—Ä–∂–∏—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ stage!"
              exit 1
            fi
            ;;
          *)
            echo "‚ö†Ô∏è  –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Ü–µ–ª–µ–≤–∞—è –≤–µ—Ç–∫–∞: $BASE"
            ;;
        esac